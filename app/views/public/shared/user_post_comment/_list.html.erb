<% @parent_comments.each do |comment| %>
  <div class="row align-items-center no-gutters mb-2">
    <!-- コメント本文（60% = col-6） -->
    <div class="col-7 pr-2 comment-body">
      <%= comment.is_deleted ? content_tag(:p, "このコメントは削除されました。", class: "text-muted") : simple_format(comment.body, {}, wrapper_tag: "p", sanitize: true) %>
    </div>

    <!-- プロフィール画像＋ニックネーム（20% = col-2） -->
    <div class="col-2 d-flex align-items-center">
      <% unless comment.is_deleted %>
        <%= image_tag(comment.user.profile_image, size: "35x35", class: "rounded-circle mr-2") %>
        <span><%= comment.user.nickname %></span>
      <% end %>
    </div>

    <!-- 返信リンク（10% = col-2） -->
    <div class="col-1 pl-1">
      <% unless comment.is_deleted %>
        <a data-toggle="collapse" href="#reply-form-<%= comment.id %>" role="button"
          aria-expanded="false" aria-controls="reply-form-<%= comment.id %>">
          返信する
        </a>
      <% end %>
    </div>

    <!-- 削除ボタン（10% = col-2） -->
    <div class="col-2">
      <% if !comment.is_deleted && (comment.user == current_user || @user_post.user == current_user) %>
        <%= button_to "削除", user_post_comment_path(@user_post.user, @user_post, comment),
              method: :delete, data: { confirm: "本当に削除しますか？" },
              class: "btn btn-danger btn-sm" %>
      <% end %>
    </div>
  </div>

  <!-- 返信フォーム -->
  <% reply_form_comment = UserPostComment.new(parent_comment_id: comment.id) %>
  <p>DEBUG: 親コメントID = <%= reply_form_comment.parent_comment_id %></p>
  <div class="collapse mb-2" id="reply-form-<%= comment.id %>">
    <div>
      <%= render partial: 'public/shared/user_post_comment/reply_form', locals: {
            user_post: @user_post,
            user_post_comment: UserPostComment.new(parent_comment_id: comment.id),
            submit_label: "返信する",
            reply_form_comment: reply_form_comment
      } %>
    </div>
  </div>

  <!-- 子コメント -->
  <% comment.replies.active.order(:created_at).each do |reply| %>
    <div>
      <div class="row align-items-center no-gutters mb-2">
        <!-- 子コメント本文（60%） -->
        <div class="col-7 pl-4  comment-body">
          <%= reply.is_deleted ? content_tag(:p, "このコメントは削除されました。", class: "text-muted") : simple_format(reply.body, {}, wrapper_tag: "p", sanitize: true) %>
        </div>

        <!-- 子コメント画像＋ニックネーム -->
        <div class="col-2 pl-4 d-flex align-items-center">
          <% unless reply.is_deleted %>
            <%= image_tag(reply.user.profile_image, size: "35x35", class: "rounded-circle mr-2") %>
            <span><%= reply.user.nickname %></span>
          <% end %>
        </div>

        <!-- 返信リンク（なし） -->
        <div class="col-1"></div>

        <!-- 削除ボタン -->
        <div class="col-2">
          <% if !reply.is_deleted && (reply.user == current_user || @user_post.user == current_user) %>
            <%= button_to "削除", user_post_comment_path(@user_post.user, @user_post, reply),
                  method: :delete, data: { confirm: "本当に削除しますか？" },
                  class: "btn btn-danger btn-sm" %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <hr>
<% end %>

<%= paginate @parent_comments %>
